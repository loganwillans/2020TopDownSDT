<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-sdt-simple.js"></script>
    <script src="js/ServerComm.js"></script>
    <script src="jspsych-6.1.0/jspsych-call-function"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    /* create timeline */
    var timeline = [];
    
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    if(typeof subject_id == 'undefined'){
      subject_id = jsPsych.randomization.randomID(30);
    }

    jsPsych.data.addProperties({
      subject_id: subject_id
    })


    /* define welcome message trial */
    var welcome = {
      type: "html-keyboard-response",
      stimulus: '<p>Thank you for participating in our study. Press any key to begin.</p>'
    };
    timeline.push(welcome);

    var debrief_trial = {
      type: 'html-keyboard-response',
      stimulus: '<p>You are done!</p>'+
                '<p>Placeholder debrief</p>'+
                '<p><a href="http://www.prolific.co">Click here to return to Prolific and complete the study</a>. You do not need a completion code.</p>',
      choices: jsPsych.NO_KEYS
    }

    var lasttimelinedata = jsPsych.data.getLastTimelineData()
    var instructions = {
      type: 'html-keyboard-response',
      stimulus: "In this experiment, you will be playing the role of a radar operator for a large civilian airport.<br> An animation will appear in the middle of your screen filled with various dots.<br>Most of these dots will be harmless civilian aircraft. However, in some trials there will be a faster dot. <br>This faster moving dot is a highjacked aircraft attempting to bomb the civilian airport. <br>Please note there are also civilians on the hijacked aircraft.<br>A scenario explaining the situation will either appear before or after the dot animation.<br>After you are given both your scenario and animation, a screen will appear asking whether or not you saw a faster moving dot.<br>On this screen you will press 'F' for yes or 'J' for no. If yes, then the number of people on the plane will be killed. <br>If no, then the number of people in the airport will be killed. <br>When you are ready to begin, press any key."
    }
    timeline.push(instructions)

    var falsePositiveScenario = {
      type: 'html-keyboard-response',
      stimulus: "Today, the airport is busy and expected to have around 500 civilians whereas the planes flying have around 100 passengers. <br>Press any key to continue.",
    }
    
    var falseNegativeScenario = {
      type: 'html-keyboard-response',
      stimulus: "The airport is quiet today with only around 100 people. The planes flying today are full with up to 500 passengers on the Airbus A380.<br>Press any key to continue.",
    }

    var pleaseAnswer = {
      type: 'html-keyboard-response',
      stimulus: "Was there a faster dot? Press 'F' for yes or 'J' for no.",
      choices: ['f', 'j'],
      on_finish: function(data){
        if(data.wasFastDot == "noFastDot" && data.key_press == 70){
          data.correct = false;
        } 
        else {
          data.correct = true;
        }
        }
    }
    
    var whitescreen = {
      type: 'html-keyboard-response',
      stimulus: '',
      trial_duration: 1000,
      choices: jsPsych.NO_KEYS
    }

    var noFastBall = {
      type: 'sdt',
      faster_or_same: 0,
    }

    var oneFastBallTrial = {
      type: 'sdt',
      faster_or_same: 1,
    }
    
    
    //False positive scenario, before the dots, with no dot moving faster
    var positiveBeforeSame = {
      timeline: [whitescreen, falsePositiveScenario, oneFastBallTrial, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
             scenarioPlacement: "before",
             scenarioType: "falsePositive"}
    }
    //False positive scenaro, before the dots, with one dot moving faster.
    var positiveBeforeDifferent = {
      timeline: [whitescreen, falsePositiveScenario, noFastBall, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "before",
             scenarioType: "falsePositive"}
    }
    //False negative scenario, before the dots, with no dot moving faster
    var negativeBeforeSame = {
      timeline: [whitescreen, falseNegativeScenario, oneFastBallTrial, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
            scenarioPlacement: "before",
            scenarioType: "falseNegative"}
    }
    //False negative scenaro, before the dots, with one dot moving faster.
    var negativeBeforeDifferent = {
      timeline: [whitescreen, falseNegativeScenario, noFastBall, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "before",
             scenarioType: "falseNegative"}
    }
    //False posative scenario, after the dots, with no dot moving faster
    var positiveAfterSame = {
      timeline: [whitescreen, oneFastBallTrial, falsePositiveScenario, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
             scenarioPlacement: "after",
             scenarioType: "falsePositive"}
    }
    //False positive scenaro, after the dots, with one dot moving faster.
    var positiveAfterDifferent = {
      timeline: [whitescreen, noFastBall, falsePositiveScenario, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "after",
             scenarioType: "falsePositive"}
    }
    //False negative scenario, after the dots, with no dot moving faster
    var negativeAfterSame = {
      timeline: [whitescreen, oneFastBallTrial, falseNegativeScenario, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
             scenarioPlacement: "after",
             scenarioType: "falseNegative"}
    }
    //False negative scenaro, after the dots, with one dot moving faster.
    var negativeAfterDifferent = {
      timeline: [whitescreen, noFastBall, falseNegativeScenario, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "after",
             scenarioType: "falseNegative"}
    }

    var trialBeforeArray = [positiveBeforeSame, positiveBeforeDifferent, negativeBeforeSame, negativeBeforeDifferent]
    var trialAfterArray = [positiveAfterSame, positiveAfterDifferent, negativeAfterSame, negativeAfterDifferent]
    var shuffledBeforeTrialArray = jsPsych.randomization.repeat(trialBeforeArray, 2)
    var shuffledAfterTrialArray = jsPsych.randomization.repeat(trialAfterArray, 2)

    function coinFlip() {
      return (Math.floor(Math.random() * 2) == 0);
      }
    if(coinFlip() == true){
      for(var i = 0; i < shuffledBeforeTrialArray.length; i++){
        timeline.push(shuffledBeforeTrialArray[i])
      }
      for(var i = 0; i < shuffledAfterTrialArray.length; i++){
        timeline.push(shuffledAfterTrialArray[i])
      }
    }
    else{
      for(var i = 0; i < shuffledAfterTrialArray.length; i++){
        timeline.push(shuffledAfterTrialArray[i])
      }
      for(var i = 0; i < shuffledBeforeTrialArray.length; i++){
       timeline.push(shuffledBeforeTrialArray[i])
      }
    }

    var saveData = {
        type: 'call-function',
        func: function(){
          serverComm.save_data(jsPsych.data.get().values())
        }
    }
    timeline.push(saveData)
    timeline.push(debrief_trial)
    
    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_finish: function(){jsPsych.data.displayData();}
    });
  </script>
</html>