<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-sdt-simple.js"></script>
    <script src="js/serverComm.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    /* create timeline */
    var timeline = [];
    
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    if(typeof subject_id == 'undefined'){
      subject_id = jsPsych.randomization.randomID(30);
    }

    jsPsych.data.addProperties({
      subject_id: subject_id
    })


    /* define welcome message trial */
    var welcome = {
      type: "html-keyboard-response",
      stimulus: "Thank you for participating in our study. <br>In this experiment, you will play the role of the radar operator for a large civilian airport. <br>You will look at a screen and see several moving dots representing planes. Most of these dots will be harmless civilian aircrafts, but on some trials you will see one, flying faster (or moving faster across the screen). <br>The faster dot is the target military aircraft intended to bomb the airport. <br>Press any key to continue."
    };
    timeline.push(welcome);

    var debrief_trial = {
      type: 'html-keyboard-response',
      stimulus: '<p>You are done!</p>'+
                '<p>This experiment looked at stimulus detection where the cue is given before the signal or after for different trials. <br>In the different trials there were cues that primed for false positive responses and false negative responses depending on how many people were at the airport versus on a plane. <br>Based on previous research, the position of the cue before or after could potentially influence the performance of signal detection <br>and we hope to further clarify through our experiment that this is a judgement call and not a physical change in signal perception.  <br>Thank you again for your participation.</p>'+
                '<p><a href="https://app.prolific.co/submissions/complete?cc=7DBB2DE5">Click here to return to Prolific and complete the study</a>. You do not need a completion code.</p>',
      choices: jsPsych.NO_KEYS
    }

    var lasttimelinedata = jsPsych.data.getLastTimelineData()
    var instructions = {
      type: 'html-keyboard-response',
      stimulus: "You only have a brief period of time to make your decision. After a few seconds the screen will go blank and you must make your decision on whether there is a faster plane.  <br>By saying yes, you are shooting a missile at that plane, killing everyone on board. <br>If you say yes when there is no faster plane, you risk killing all the civilians on the plane. <br>By saying no even if there is a faster military plane present, the military plane bombs the airport, killing all the civilians there. <br>To say yes there is a faster plane press the ‘F’. To say no, press ‘J’. <br>In each round, you will get information on how many people are in the airport and how many are in the planes to help you make your choice. <br>In some rounds, this information will be presented before you see the screen of dots and in others you will get this information after you see the screen. <br>To continue press any key to begin. Good luck!"

    } 
    timeline.push(instructions)

    var falsePositiveScenario = {
      type: 'html-keyboard-response',
      stimulus: "Today, the airport is busy and expected to have around 500 civilians whereas the planes flying have around 100 passengers. <br>Press any key to continue.",
    }
    
    var falseNegativeScenario = {
      type: 'html-keyboard-response',
      stimulus: "The airport is quiet today with only around 100 people. The planes flying today are full with up to 500 passengers on the Airbus A380.<br>Press any key to continue.",
    }

    var pleaseAnswer = {
      type: 'html-keyboard-response',
      stimulus: "Was there a faster dot? Press 'F' for yes or 'J' for no.",
      choices: ['f', 'j'],
      on_finish: function(data){
        if(data.wasFastDot == "noFastDot" && data.key_press == 70){
          data.correct = false;
        } 
        else {
          data.correct = true;
        }
        }
    }
    
    var whitescreen = {
      type: 'html-keyboard-response',
      stimulus: '',
      trial_duration: 1000,
      choices: jsPsych.NO_KEYS
    }

    var noFastBall = {
      type: 'sdt',
      faster_or_same: 0,
    }

    var oneFastBallTrial = {
      type: 'sdt',
      faster_or_same: 1,
    }
    
    
    //False positive scenario, before the dots, with no dot moving faster
    var positiveBeforeSame = {
      timeline: [whitescreen, falsePositiveScenario, oneFastBallTrial, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
             scenarioPlacement: "before",
             scenarioType: "falsePositive"}
    }
    //False positive scenaro, before the dots, with one dot moving faster.
    var positiveBeforeDifferent = {
      timeline: [whitescreen, falsePositiveScenario, noFastBall, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "before",
             scenarioType: "falsePositive"}
    }
    //False negative scenario, before the dots, with no dot moving faster
    var negativeBeforeSame = {
      timeline: [whitescreen, falseNegativeScenario, oneFastBallTrial, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
            scenarioPlacement: "before",
            scenarioType: "falseNegative"}
    }
    //False negative scenaro, before the dots, with one dot moving faster.
    var negativeBeforeDifferent = {
      timeline: [whitescreen, falseNegativeScenario, noFastBall, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "before",
             scenarioType: "falseNegative"}
    }
    //False posative scenario, after the dots, with no dot moving faster
    var positiveAfterSame = {
      timeline: [whitescreen, oneFastBallTrial, falsePositiveScenario, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
             scenarioPlacement: "after",
             scenarioType: "falsePositive"}
    }
    //False positive scenaro, after the dots, with one dot moving faster.
    var positiveAfterDifferent = {
      timeline: [whitescreen, noFastBall, falsePositiveScenario, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "after",
             scenarioType: "falsePositive"}
    }
    //False negative scenario, after the dots, with no dot moving faster
    var negativeAfterSame = {
      timeline: [whitescreen, oneFastBallTrial, falseNegativeScenario, pleaseAnswer],
      data: {wasFastDot: "noFastDot",
             scenarioPlacement: "after",
             scenarioType: "falseNegative"}
    }
    //False negative scenaro, after the dots, with one dot moving faster.
    var negativeAfterDifferent = {
      timeline: [whitescreen, noFastBall, falseNegativeScenario, pleaseAnswer],
      data: {wasFastDot: "yesFastDot",
             scenarioPlacement: "after",
             scenarioType: "falseNegative"}
    }

    var trialBeforeArray = [positiveBeforeSame, positiveBeforeDifferent, negativeBeforeSame, negativeBeforeDifferent]
    var trialAfterArray = [positiveAfterSame, positiveAfterDifferent, negativeAfterSame, negativeAfterDifferent]
    var shuffledBeforeTrialArray = jsPsych.randomization.repeat(trialBeforeArray, 2)
    var shuffledAfterTrialArray = jsPsych.randomization.repeat(trialAfterArray, 2)

    function coinFlip() {
      return (Math.floor(Math.random() * 2) == 0);
      }
    if(coinFlip() == true){
      for(var i = 0; i < shuffledBeforeTrialArray.length; i++){
        timeline.push(shuffledBeforeTrialArray[i])
      }
      for(var i = 0; i < shuffledAfterTrialArray.length; i++){
        timeline.push(shuffledAfterTrialArray[i])
      }
    }
    else{
      for(var i = 0; i < shuffledAfterTrialArray.length; i++){
        timeline.push(shuffledAfterTrialArray[i])
      }
      for(var i = 0; i < shuffledBeforeTrialArray.length; i++){
       timeline.push(shuffledBeforeTrialArray[i])
      }
    }

    var saveData = {
        type: 'call-function',
        func: function(){
          serverComm.save_data(jsPsych.data.get().values())
        }
    }
    var survey_trial = {
  type: 'survey-text',
  questions: [
    {prompt: "Did you run into any issues while completing this experiment?", name: 'issues'}, 
  ],
};
    timeline.push(saveData)
    timeline.push(survey_trial)
    timeline.push(debrief_trial)
    
    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_finish: function(){jsPsych.data.displayData();}
    });
  </script>
</html>